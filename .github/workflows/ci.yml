name: Personal Finance Management App CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        node-version: [18]
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      timeout-minutes: 5

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
      timeout-minutes: 5

    - name: Install Backend Dependencies
      working-directory: ./backend
      run: npm ci
      timeout-minutes: 10

    - name: Install Frontend Dependencies
      working-directory: ./frontend
      run: |
        df -h
        rm -rf ./build || true
        npm ci
      timeout-minutes: 15

    - name: Build Frontend
      working-directory: ./frontend
      run: npm run build
      timeout-minutes: 10

    - name: Run Backend Tests
      env:
        MONGO_URI: ${{ secrets.MONGO_URI }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        PORT: ${{ secrets.PORT }}
      working-directory: ./backend
      run: npm test
      timeout-minutes: 5

  deploy:
    name: Deploy to AWS
    runs-on: self-hosted
    needs: test
    timeout-minutes: 15
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      timeout-minutes: 5

    - name: Stop Running Services
      run: pm2 stop all || true
      timeout-minutes: 2

    - name: Install Backend Dependencies
      working-directory: ./backend
      run: npm ci
      timeout-minutes: 10

    - name: Create Production Environment File
      working-directory: ./backend
      run: |
        echo "MONGO_URI=${{ secrets.MONGO_URI }}" > .env
        echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
        echo "PORT=${{ secrets.PORT }}" >> .env
      timeout-minutes: 2

    - name: Deploy Backend
      working-directory: ./backend
      run: |
        pm2 start server.js --name personal-finance-backend || pm2 restart personal-finance-backend
        pm2 save
        pm2 list
                 echo "ğŸš€ Backend deployed successfully!"
         echo "ğŸŒ Your API is now live at: http://16.176.9.42:5001"
        echo "ğŸ“‹ API Endpoints:"
        echo "   - POST /api/auth/register"
        echo "   - POST /api/auth/login"
        echo "   - GET /api/transactions"
        echo "   - POST /api/transactions"
        echo "   - GET /api/budgets"
        echo "   - POST /api/budgets"
        echo "   - GET /api/savings-goals"
        echo "   - POST /api/savings-goals"
      timeout-minutes: 5