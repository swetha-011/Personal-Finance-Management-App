name: Personal Finance Management App CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test-and-deploy:
    name: Test and Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        node-version: [18]
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      timeout-minutes: 5

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
      timeout-minutes: 5

    - name: Install Backend Dependencies
      working-directory: ./backend
      run: npm ci
      timeout-minutes: 10

    - name: Install Frontend Dependencies
      working-directory: ./frontend
      run: |
        df -h
        rm -rf ./build || true
        npm ci
      timeout-minutes: 15

    - name: Build Frontend
      working-directory: ./frontend
      run: npm run build
      timeout-minutes: 10

    - name: Run Backend Tests
      env:
        MONGO_URI: ${{ secrets.MONGO_URI }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        PORT: ${{ secrets.PORT }}
      working-directory: ./backend
      run: npm test
      timeout-minutes: 5

    - name: Deploy Status
      run: |
        echo "‚úÖ All tests passed successfully!"
        echo "‚úÖ Frontend built successfully!"
        echo "‚úÖ Backend is ready for deployment!"
        echo ""
        echo "üåê Deployment Information:"
        echo "- Backend API: Ready for deployment to EC2"
        echo "- Frontend: Built and ready for S3/CloudFront"
        echo "- Database: MongoDB Atlas connected"
        echo ""
        echo "üìã Next Steps:"
        echo "1. Self-hosted runner needs to be restarted on EC2"
        echo "2. Deploy backend to EC2 instance"
        echo "3. Deploy frontend to S3/CloudFront"
        echo "4. Configure domain and SSL"
      timeout-minutes: 2